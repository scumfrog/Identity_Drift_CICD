name: 05-alt

on:
  push:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

jobs:
  oidc:
    runs-on: ubuntu-latest
    steps:
      - name: AWS proof (AssumeRoleWithWebIdentity + ListBucket)
        env:
          AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
          AWS_LAB_BUCKET: ${{ secrets.AWS_LAB_BUCKET }}
          AWS_REGION: eu-west-1
          AWS_DEFAULT_REGION: eu-west-1
        run: |
          set -euo pipefail
          echo "Requesting GitHub OIDC token for AWS STS..."
          TOKEN="$(python3 - <<'PY'
          import json, os, urllib.request
          req_url = os.environ["ACTIONS_ID_TOKEN_REQUEST_URL"]
          req_tok = os.environ["ACTIONS_ID_TOKEN_REQUEST_TOKEN"]
          url = req_url + "&audience=sts.amazonaws.com"
          req = urllib.request.Request(url, headers={"Authorization":"Bearer " + req_tok})
          print(json.loads(urllib.request.urlopen(req).read())["value"])
          PY
          )"
          echo "Assuming role via STS..."
          set +e
          CREDS_JSON="$(aws sts assume-role-with-web-identity \
            --role-arn "$AWS_ROLE_ARN" \
            --role-session-name "gh-${GITHUB_RUN_ID:-run}" \
            --web-identity-token "$TOKEN" \
            --duration-seconds 900 2> assume_err.txt)"
          rc=$?
          set -e
          if [ "$rc" -ne 0 ]; then
            echo "assume-role-with-web-identity failed (rc=$rc):"
            cat assume_err.txt
            exit "$rc"
          fi
          CREDS_JSON="$CREDS_JSON" python3 - <<'PY' > aws_env.sh
          import json, os
          d=json.loads(os.environ["CREDS_JSON"])
          c=d["Credentials"]
          print(f"AWS_ACCESS_KEY_ID={c['AccessKeyId']}")
          print(f"AWS_SECRET_ACCESS_KEY={c['SecretAccessKey']}")
          print(f"AWS_SESSION_TOKEN={c['SessionToken']}")
          PY
          set -a
          . ./aws_env.sh
          set +a
          echo "Listing bucket..."
          aws s3api list-objects-v2 --bucket "$AWS_LAB_BUCKET" --max-keys 5
      - name: Collect context
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json, os
          ctx = {
            "event_name": os.environ.get("GITHUB_EVENT_NAME"),
            "ref": os.environ.get("GITHUB_REF"),
            "sha": os.environ.get("GITHUB_SHA"),
            "actor": os.environ.get("GITHUB_ACTOR"),
            "repository": os.environ.get("GITHUB_REPOSITORY"),
            "workflow": os.environ.get("GITHUB_WORKFLOW"),
            "job": os.environ.get("GITHUB_JOB"),
            "run_id": os.environ.get("GITHUB_RUN_ID"),
            "run_attempt": os.environ.get("GITHUB_RUN_ATTEMPT"),
          }
          open("context.json","w",encoding="utf-8").write(json.dumps(ctx, indent=2, sort_keys=True))
          print(json.dumps(ctx, indent=2, sort_keys=True))
          PY
      - name: Request OIDC token and call consumer
        env:
          CONSUMER_URL: ${{ secrets.CONSUMER_URL }}
          AUDIENCE: ci-oidc-lab
        run: |
          set -euo pipefail
          if [ -z "${CONSUMER_URL:-}" ]; then
            echo '{"ok":false,"error":"missing_CONSUMER_URL_secret","workflow_context":{}}' > result.json
            exit 0
          fi
          ENDPOINT="$CONSUMER_URL"
          case "$ENDPOINT" in
            */introspect) ;;
            *) ENDPOINT="${ENDPOINT%/}/introspect" ;;
          esac
          TOKEN="$(python3 - <<'PY'
          import os, json, urllib.request
          aud = os.environ.get("AUDIENCE","")
          req_url = os.environ["ACTIONS_ID_TOKEN_REQUEST_URL"]
          req_tok = os.environ["ACTIONS_ID_TOKEN_REQUEST_TOKEN"]
          url = req_url + ("&audience=" + aud if aud else "")
          req = urllib.request.Request(url, headers={"Authorization":"Bearer " + req_tok})
          print(json.loads(urllib.request.urlopen(req).read())["value"])
          PY
          )"
          : > result_raw.txt
          : > http_code.txt
          curl -sS -X POST "$ENDPOINT" -H "Authorization: Bearer $TOKEN" -o result_raw.txt -w "%{http_code}" > http_code.txt || true
          python3 - <<'PY'
          import json
          from pathlib import Path

          ctx = json.load(open("context.json","r",encoding="utf-8"))
          http_code = (Path("http_code.txt").read_text(encoding="utf-8").strip() or "000") if Path("http_code.txt").exists() else "000"
          body = Path("result_raw.txt").read_text(encoding="utf-8", errors="replace") if Path("result_raw.txt").exists() else ""
          try:
            res = json.loads(body)
          except Exception:
            res = {
              "ok": False,
              "error": "consumer_response_not_json_or_unreachable",
              "consumer_http_code": http_code,
              "consumer_body_prefix": body[:2000],
            }
          res["workflow_context"] = ctx
          json.dump(res, open("result.json","w",encoding="utf-8"), indent=2, sort_keys=True)
          print(json.dumps(res, indent=2, sort_keys=True))
          PY
      - name: Upload result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: oidc-result-alt
          path: |
            result.json
            context.json
